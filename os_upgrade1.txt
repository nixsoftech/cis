# Install update-manager-core
install_update_manager:
  pkg.installed:
    - name: update-manager-core

# Configure release-upgrades for LTS upgrades
configure_release_upgrades:
  file.managed:
    - name: /etc/update-manager/release-upgrades
    - contents: |
        [DEFAULT]
        Prompt=lts
    - require:
      - pkg: install_update_manager

# Step 1: Configure repository for current codename and upgrade to 20.04
{% set codename = grains['lsb_distrib_codename'] %}
configure_repo_initial:
  pkgrepo.managed:
    - humanname: Custom Ubuntu Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu {{ codename }} main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: True
    - onlyif: lsb_release -cs | grep -q bionic
  pkgrepo.managed:
    - humanname: Custom Ubuntu Security Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu {{ codename }}-security main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: False
    - onlyif: lsb_release -cs | grep -q bionic
  pkgrepo.managed:
    - humanname: Custom Ubuntu Updates Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu {{ codename }}-updates main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: False
    - onlyif: lsb_release -cs | grep -q bionic

update_package_cache_initial:
  pkg.uptodate:
    - require:
      - pkgrepo: configure_repo_initial

backup_installed_packages_list:
  cmd.run:
    - name: dpkg -l > /var/log/installed_packages_pre_upgrade.txt
    - creates: /var/log/installed_packages_pre_upgrade.txt
    - require:
      - pkg: update_package_cache_initial

upgrade_to_2004:
  cmd.run:
    - name: DEBIAN_FRONTEND=noninteractive do-release-upgrade -f DistUpgradeViewNonInteractive
    - unless: lsb_release -cs | grep -q focal
    - require:
      - file: configure_release_upgrades
      - cmd: backup_installed_packages_list

reboot_after_2004:
  cmd.run:
    - name: reboot
    - require:
      - cmd: upgrade_to_2004
    - onlyif: test -f /var/run/reboot-required

wait_for_reboot_2004:
  cmd.run:
    - name: |
        for i in {1..60}; do
          if ping -c 1 10.13.0.81 >/dev/null; then
            sleep 10
            salt '{{ grains['id'] }}' test.ping && break
          fi
          sleep 30
        done
    - require:
      - cmd: reboot_after_2004
    - onlyif: lsb_release -cs | grep -q focal

# Step 2: Configure repository for 20.04 and upgrade to 22.04
configure_repo_focal:
  pkgrepo.managed:
    - humanname: Custom Ubuntu Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: True
    - require:
      - cmd: wait_for_reboot_2004
    - onlyif: lsb_release -cs | grep -q focal
  pkgrepo.managed:
    - humanname: Custom Ubuntu Security Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal-security main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: False
    - require:
      - cmd: wait_for_reboot_2004
    - onlyif: lsb_release -cs | grep -q focal
  pkgrepo.managed:
    - humanname: Custom Ubuntu Updates Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu focal-updates main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: False
    - require:
      - cmd: wait_for_reboot_2004
    - onlyif: lsb_release -cs | grep -q focal

update_package_cache_focal:
  pkg.uptodate:
    - require:
      - pkgrepo: configure_repo_focal

upgrade_to_2204:
  cmd.run:
    - name: DEBIAN_FRONTEND=noninteractive do-release-upgrade -f DistUpgradeViewNonInteractive
    - unless: lsb_release -cs | grep -q jammy
    - require:
      - pkg: update_package_cache_focal

reboot_after_2204:
  cmd.run:
    - name: reboot
    - require:
      - cmd: upgrade_to_2204
    - onlyif: test -f /var/run/reboot-required

wait_for_reboot_2204:
  cmd.run:
    - name: |
        for i in {1..60}; do
          if ping -c 1 10.13.0.81 >/dev/null; then
            sleep 10
            salt '{{ grains['id'] }}' test.ping && break
          fi
          sleep 30
        done
    - require:
      - cmd: reboot_after_2204
    - onlyif: lsb_release -cs | grep -q jammy

# Step 3: Configure repository for 22.04
configure_repo_jammy:
  pkgrepo.managed:
    - humanname: Custom Ubuntu Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: True
    - require:
      - cmd: wait_for_reboot_2204
    - onlyif: lsb_release -cs | grep -q jammy
  pkgrepo.managed:
    - humanname: Custom Ubuntu Security Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-security main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: False
    - require:
      - cmd: wait_for_reboot_2204
    - onlyif: lsb_release -cs | grep -q jammy
  pkgrepo.managed:
    - humanname: Custom Ubuntu Updates Repository
    - name: deb [arch=amd64] http://10.13.0.88:8080/ubuntu jammy-updates main
    - file: /etc/apt/sources.list.d/custom-ubuntu.list
    - key_url: http://10.13.0.88:8080/ubuntu/key.asc
    - refresh: True
    - clean_file: False
    - require:
      - cmd: wait_for_reboot_2204
    - onlyif: lsb_release -cs | grep -q jammy

update_package_cache_jammy:
  pkg.uptodate:
    - require:
      - pkgrepo: configure_repo_jammy

# Log upgrade failures
log_upgrade_failure:
  cmd.run:
    - name: echo "Upgrade failed at $(date)" >> /var/log/upgrade.log
    - onfail:
      - cmd: upgrade_to_2004
      - cmd: upgrade_to_2204
